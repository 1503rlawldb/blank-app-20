import streamlit as st
import pandas as pd
import numpy as np
import pydeck as pdk
import matplotlib.pyplot as plt
from datetime import datetime

# --- í˜ì´ì§€ ê¸°ë³¸ ì„¤ì • ---
st.set_page_config(
    page_title="ë¬¼ëŸ¬ì„œëŠ” ë•…, ë‹¤ê°€ì˜¤ëŠ” ë°”ë‹¤",
    page_icon="ğŸŒŠ",
    layout="wide"
)

# ----------------------------
# 1. ì¢Œì¸¡ ì¡°ì‘ ì˜µì…˜
# ----------------------------
st.sidebar.header("ë³´ê¸° ì˜µì…˜")

# ë‚ ì§œ ì„ íƒ (ë…„ë„ ë‹¨ìœ„)
year = st.sidebar.slider("ë…„ë„ ì„ íƒ", 1800, 2025, 2024)

# ì§€ì—­ ì„ íƒ
region = st.sidebar.selectbox("ì§€ì—­ ì„ íƒ", ["ì „ ì„¸ê³„", "ëŒ€í•œë¯¼êµ­", "íˆ¬ë°œë£¨", "ëª°ë””ë¸Œ", "ë°©ê¸€ë¼ë°ì‹œ", "ë„¤ëœë€ë“œ"])

# ìƒ‰ìƒ ë²”ìœ„ ì¡°ì ˆ
temp_range = st.sidebar.slider("ìƒ‰ìƒ ë²”ìœ„ ì ˆëŒ€ê°’ (Â°C)", 1, 10, 5)

# ì§€ë„ íˆ¬ì˜ ë°©ì‹ (ìƒ˜í”Œ)
projection = st.sidebar.selectbox("íˆ¬ì˜(í™”ë©´)", ["Robinson", "Equirectangular", "Mercator"])

# ----------------------------
# 2. ì§€ë„ ë°ì´í„° (ìƒ˜í”Œ ìƒì„±)
# ----------------------------
# ìƒ˜í”Œ ê²©ì ë°ì´í„°
lats = np.linspace(-60, 80, 50)
lons = np.linspace(-180, 180, 100)
temp_anomaly = np.random.uniform(-temp_range, temp_range, size=(len(lats)*len(lons)))

df_map = pd.DataFrame({
    "lat": np.repeat(lats, len(lons)),
    "lon": np.tile(lons, len(lats)),
    "anomaly": temp_anomaly
})

# ----------------------------
# 3. ì§€ë„ ì‹œê°í™”
# ----------------------------
st.subheader(f"ğŸŒ í•´ìˆ˜ë©´Â·ê¸°ì˜¨ ë³€í™” ì§€ë„ ({year}ë…„ ê¸°ì¤€)")
st.pydeck_chart(pdk.Deck(
    map_style="mapbox://styles/mapbox/light-v9",
    initial_view_state=pdk.ViewState(latitude=0, longitude=0, zoom=1),
    layers=[
        pdk.Layer(
            "HeatmapLayer",
            data=df_map,
            get_position=["lon", "lat"],
            get_weight="anomaly",
            radiusPixels=30,
            opacity=0.6
        )
    ]
))

# ----------------------------
# 4. ë‚˜ë¼ë³„ í”¼í•´ ì‚¬ë¡€ / ëŒ€ì²˜ ë°©ì•ˆ
# ----------------------------
case_study = {
    "íˆ¬ë°œë£¨": {
        "í”¼í•´": "êµ­í† ì˜ 40% ì´ìƒì´ ì¹¨ìˆ˜ ìœ„í˜‘ì„ ë°›ê³  ìˆìœ¼ë©°, ì£¼ë¯¼ë“¤ì˜ í•´ì™¸ ì´ì£¼ê°€ í˜„ì‹¤í™”ë˜ê³  ìˆìŒ.",
        "ëŒ€ì²˜": "êµ­ì œ ì‚¬íšŒì— ê¸°í›„ ë‚œë¯¼ ë³´í˜¸ ìš”ì²­, í•´ì•ˆ ë°©ë²½ ì„¤ì¹˜ ì‹œë„."
    },
    "ëª°ë””ë¸Œ": {
        "í”¼í•´": "ë¦¬ì¡°íŠ¸ì™€ ì£¼ê±°ì§€ê°€ ë°˜ë³µì ì¸ í™ìˆ˜ í”¼í•´ë¥¼ ì…ìŒ.",
        "ëŒ€ì²˜": "ì¸ê³µì„¬ ê±´ì„¤, í•´ì•ˆ ë°©íŒŒì œ ê°•í™”."
    },
    "ë°©ê¸€ë¼ë°ì‹œ": {
        "í”¼í•´": "ë¸íƒ€ ì§€ì—­ ë†ê²½ì§€ì™€ ë§ˆì„ì´ ë§¤ë…„ ì¹¨ìˆ˜ë¨.",
        "ëŒ€ì²˜": "ë°©ì¡°ì œ ê±´ì„¤, í™ìˆ˜ ì˜ˆì¸¡ ì‹œìŠ¤í…œ ê°œë°œ."
    },
    "ë„¤ëœë€ë“œ": {
        "í”¼í•´": "ê³¼ê±° í•´ìˆ˜ë©´ ìƒìŠ¹ê³¼ í­í’ìœ¼ë¡œ êµ­í†  ì¹¨ìˆ˜ ê²½í—˜.",
        "ëŒ€ì²˜": "ì„¸ê³„ì  ìˆ˜ì¤€ì˜ ë°©ì¡°ì œÂ·ìˆ˜ë¬¸ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬ì¶•."
    },
    "ëŒ€í•œë¯¼êµ­": {
        "í”¼í•´": "ì¸ì²œÂ·ë¶€ì‚° ë“± í•´ì•ˆ ë„ì‹œ ì¹¨ìˆ˜ ìœ„í—˜ ì¦ê°€.",
        "ëŒ€ì²˜": "ì—°ì•ˆê´€ë¦¬ ê¸°ë³¸ê³„íš ìˆ˜ë¦½, í•´ì•ˆ ë°©ë²½Â·ë°°ìˆ˜ ì‹œì„¤ í™•ì¶©."
    }
}

if region in case_study:
    st.markdown(f"### ğŸ“ {region} í”¼í•´ ì‚¬ë¡€ & ëŒ€ì²˜ ë°©ì•ˆ")
    st.write(f"**í”¼í•´ ì‚¬ë¡€:** {case_study[region]['í”¼í•´']}")
    st.write(f"**ëŒ€ì²˜ ë°©ì•ˆ:** {case_study[region]['ëŒ€ì²˜']}")

# ----------------------------
# 5. í˜„ì¬(2025) vs ì„ íƒë…„ë„ ë¹„êµ
# ----------------------------
st.subheader("ğŸ“Š í•´ìˆ˜ë©´ ìƒìŠ¹ ìˆ˜ì¹˜ ë¹„êµ")

current_sea_level = 21.0  # cm (ì˜ˆì‹œ)
selected_sea_level = round(np.random.uniform(0, current_sea_level), 2)

col1, col2 = st.columns(2)
col1.metric(f"{year}ë…„ í•´ìˆ˜ë©´ ìƒìŠ¹(cm)", selected_sea_level)
col2.metric("2025ë…„ í•´ìˆ˜ë©´ ìƒìŠ¹(cm)", current_sea_level, delta=f"{current_sea_level-selected_sea_level:.2f} cm")

# ----------------------------
# 6. íˆ¬ë°œë£¨ í”¼í•´ íŠ¹ë³„ ê°•ì¡°
# ----------------------------
st.subheader("ğŸŒŠ íˆ¬ë°œë£¨ì˜ ìœ„ê¸°")
st.info("íˆ¬ë°œë£¨ëŠ” í•´ìˆ˜ë©´ ìƒìŠ¹ìœ¼ë¡œ êµ­í†  ëŒ€ë¶€ë¶„ì´ ì¹¨ìˆ˜ ìœ„ê¸°ì— ì²˜í•´ ìˆìœ¼ë©°, ê¸°í›„ ë‚œë¯¼ ë¬¸ì œê°€ êµ­ì œì  ì´ìŠˆë¡œ ë– ì˜¤ë¥´ê³  ìˆìŠµë‹ˆë‹¤.")

# ----------------------------
# 7. í•´ìˆ˜ë©´ ìƒìŠ¹ ì¸ì§€ë„ ì²´í¬ë°•ìŠ¤
# ----------------------------
st.subheader("ğŸ“ ì„±ì°°: ë‚˜ëŠ” ì–¼ë§ˆë‚˜ ì•Œê³  ìˆì„ê¹Œ?")
st.checkbox("í•´ìˆ˜ë©´ ìƒìŠ¹ì´ ë‚´ ì‚¶ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆë‹¤ê³  ìƒê°í•œë‹¤.")
st.checkbox("êµ­ì œ ì‚¬íšŒê°€ í•¨ê»˜ í•´ê²°í•´ì•¼ í•œë‹¤ê³  ìƒê°í•œë‹¤.")
st.checkbox("ê°œì¸ì ìœ¼ë¡œ ê¸°í›„ í–‰ë™ì— ì°¸ì—¬í•  ì˜í–¥ì´ ìˆë‹¤.")

# ----------------------------
# 8. ì¶œì²˜
# ----------------------------
st.markdown("---")
st.markdown("#### ğŸ“š ì¶œì²˜")
st.markdown("""
- [IPCC Reports](https://www.ipcc.ch/)  
- [NASA Climate Change](https://climate.nasa.gov/)  
- [NOAA Sea Level Rise](https://coast.noaa.gov/slr/)  
""")
