import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px

# --- í˜ì´ì§€ ê¸°ë³¸ ì„¤ì • ---
st.set_page_config(
    page_title="ë¬¼ëŸ¬ì„œëŠ” ë•…, ë‹¤ê°€ì˜¤ëŠ” ë°”ë‹¤",
    page_icon="ğŸŒŠ",
    layout="wide"
)

# --- ì œëª© ë° ì†Œê°œ ---
st.title("ğŸŒŠ í•´ìˆ˜ë©´ ìƒìŠ¹ ëŒ€ì‹œë³´ë“œ")
st.markdown("""
í•´ìˆ˜ë©´ ìƒìŠ¹ì€ ë” ì´ìƒ ë¨¼ ë¯¸ë˜ì˜ ì´ì•¼ê¸°ê°€ ì•„ë‹™ë‹ˆë‹¤. ì´ ëŒ€ì‹œë³´ë“œëŠ” ì‹œê°„ì˜ íë¦„ì— ë”°ë¥¸ í•´ìˆ˜ë©´ ë³€í™”ë¥¼ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì£¼ê³ ,
ì£¼ìš” í”¼í•´ êµ­ê°€ë“¤ì˜ í˜„ì‹¤ê³¼ ëŒ€ì‘ ë…¸ë ¥ì„ ì¡°ëª…í•©ë‹ˆë‹¤. **ì¢Œì¸¡ ì‚¬ì´ë“œë°”**ì—ì„œ ì—°ë„ì™€ ì§€ì—­ì„ ì„ íƒí•˜ì—¬ ë³€í™”ë¥¼ ì§ì ‘ í™•ì¸í•´ë³´ì„¸ìš”.
""")
st.markdown("---")

# ----------------------------
# ë°ì´í„° ìƒì„± (ì‹œë®¬ë ˆì´ì…˜)
# ----------------------------
@st.cache_data
def generate_sea_level_data():
    """1880ë…„ë¶€í„° 2025ë…„ê¹Œì§€ì˜ í•´ìˆ˜ë©´ ìƒìŠ¹ ë°ì´í„°ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤."""
    years = np.arange(1880, 2026)
    # ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ìƒìŠ¹í­ì´ ì»¤ì§€ëŠ” ë¹„ì„ í˜•ì  ì¦ê°€ë¥¼ ì‹œë®¬ë ˆì´ì…˜
    base_rise = 0.008 * (years - 1880)**2 + np.random.normal(0, 5, len(years))
    sea_level_mm = base_rise - base_rise[0]  # ì‹œì‘ì ì„ 0ìœ¼ë¡œ ë§ì¶¤
    return pd.DataFrame({'Year': years, 'Sea Level Rise (mm)': sea_level_mm})

df_sea_level = generate_sea_level_data()

# ----------------------------
# 1. ì¢Œì¸¡ ì¡°ì‘ ì˜µì…˜
# ----------------------------
st.sidebar.header("âš™ï¸ ë³´ê¸° ì˜µì…˜")
selected_year = st.sidebar.slider("â‘  ì—°ë„ ì„ íƒ", 1880, 2025, 2025)
selected_region = st.sidebar.selectbox("â‘¡ ì£¼ìš” í”¼í•´ ì§€ì—­ ì„ íƒ", ["ì „ ì„¸ê³„", "ëŒ€í•œë¯¼êµ­", "íˆ¬ë°œë£¨", "ëª°ë””ë¸Œ", "ë°©ê¸€ë¼ë°ì‹œ", "ë„¤ëœë€ë“œ"])

# ----------------------------
# 2. ì „ ì„¸ê³„ í•´ìˆ˜ë©´ ìƒìŠ¹ í˜„í™©
# ----------------------------
st.header(f"ğŸ“ˆ {selected_year}ë…„, ì „ ì„¸ê³„ í•´ìˆ˜ë©´ ìƒìŠ¹ í˜„í™©")

# ì„ íƒëœ ì—°ë„ê¹Œì§€ì˜ ë°ì´í„° í•„í„°ë§
df_filtered_by_year = df_sea_level[df_sea_level['Year'] <= selected_year]

# 2-1. ì£¼ìš” ìˆ˜ì¹˜ í‘œì‹œ
latest_data = df_filtered_by_year.iloc[-1]
ten_years_ago_data = df_sea_level[df_sea_level['Year'] == selected_year - 10]

current_level = latest_data['Sea Level Rise (mm)']
delta = None
if not ten_years_ago_data.empty:
    delta = current_level - ten_years_ago_data.iloc[0]['Sea Level Rise (mm)']

col1, col2, col3 = st.columns(3)
col1.metric(
    label=f"{selected_year}ë…„ ëˆ„ì  ìƒìŠ¹ëŸ‰ (mm)",
    value=f"{current_level:.2f}",
    delta=f"{delta:.2f} (10ë…„ ì „ ëŒ€ë¹„)" if delta is not None else "ë°ì´í„° ì—†ìŒ",
    delta_color="inverse"
)
col2.metric(label="ì¸¡ì • ê¸°ì¤€ ì—°ë„", value="1880ë…„")
col3.metric(label="ë°ì´í„°", value="ì‹œë®¬ë ˆì´ì…˜")

# 2-2. ì‹œê°„ì— ë”°ë¥¸ ë³€í™” ê·¸ë˜í”„
with st.container(border=True):
    st.subheader("ì—°ë„ë³„ ëˆ„ì  ìƒìŠ¹ëŸ‰ ë³€í™”")
    fig = px.line(df_filtered_by_year, x='Year', y='Sea Level Rise (mm)',
                  labels={'Year': 'ì—°ë„', 'Sea Level Rise (mm)': 'ìƒìŠ¹ëŸ‰ (mm)'})
    fig.update_layout(
        margin=dict(l=20, r=20, t=30, b=20),
        plot_bgcolor='rgba(0,0,0,0)',
        paper_bgcolor='#f0f2f6'
    )
    st.plotly_chart(fig, use_container_width=True)

st.markdown("---")

# ----------------------------
# 3. ë‚˜ë¼ë³„ í”¼í•´ ì‚¬ë¡€ / ëŒ€ì²˜ ë°©ì•ˆ
# ----------------------------
case_study = {
    "íˆ¬ë°œë£¨": {"í”¼í•´": "í•´ë°œê³ ë„ê°€ ë§¤ìš° ë‚®ì•„ êµ­í† ì˜ 40% ì´ìƒì´ ë§Œì¡° ì‹œ ì¹¨ìˆ˜ë©ë‹ˆë‹¤. ì‹ìˆ˜ ì˜¤ì—¼, ë†ê²½ì§€ íŒŒê´´ê°€ ì‹¬ê°í•˜ë©° ì£¼ë¯¼ë“¤ì€ ë‰´ì§ˆëœë“œ ë“±ìœ¼ë¡œ ì´ì£¼í•˜ê³  ìˆìŠµë‹ˆë‹¤. 'ë””ì§€í„¸ êµ­ê°€'ë¡œì˜ ì „í™˜ì„ ì„ ì–¸í•˜ë©° êµ­ì œ ì‚¬íšŒì— ê¸°í›„ ìœ„ê¸°ì˜ ì‹¬ê°ì„±ì„ ì•Œë¦¬ê³  ìˆìŠµë‹ˆë‹¤.", "ëŒ€ì²˜": "êµ­ì œ ì‚¬íšŒì— ê¸°í›„ ë‚œë¯¼ ë³´í˜¸ ìš”ì²­, í•´ì•ˆ ë°©ë²½ ì„¤ì¹˜, êµ­ê°€ ì •ë³´ë¥¼ ë””ì§€í„¸ë¡œ ë³´ì¡´í•˜ëŠ” 'ë¯¸ë˜ì˜ êµ­ê°€' í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤."},
    "ëª°ë””ë¸Œ": {"í”¼í•´": "1200ì—¬ ê°œì˜ ì‚°í˜¸ì„¬ìœ¼ë¡œ ì´ë£¨ì–´ì§„ ëª°ë””ë¸ŒëŠ” 80% ì´ìƒì´ í•´ë°œ 1m ë¯¸ë§Œì…ë‹ˆë‹¤. í•´ìˆ˜ë©´ì´ 1m ìƒìŠ¹í•˜ë©´ êµ­í†  ëŒ€ë¶€ë¶„ì´ ì‚¬ë¼ì§ˆ ìœ„ê¸°ì— ì²˜í•´ ìˆìœ¼ë©°, ê´€ê´‘ ì‚°ì—…ê³¼ êµ­ë¯¼ì˜ ìƒì¡´ì„ ì§ì ‘ì ìœ¼ë¡œ ìœ„í˜‘í•©ë‹ˆë‹¤.", "ëŒ€ì²˜": "í•´ìƒ ë¶€ìœ  ë„ì‹œ 'ëª°ë””ë¸Œ í”Œë¡œíŒ… ì‹œí‹°' ê±´ì„¤, ìˆ˜ë„ ë§ë ˆ ì£¼ë³€ì— ê±°ëŒ€í•œ ë°©íŒŒì œ ê±´ì„¤, ì‚°í˜¸ì´ˆ ë³µì› ì‚¬ì—… ë“±ì„ í†µí•´ ëŒ€ì‘í•˜ê³  ìˆìŠµë‹ˆë‹¤."},
    "ë°©ê¸€ë¼ë°ì‹œ": {"í”¼í•´": "ì¸êµ¬ ë°€ë„ê°€ ë†’ì€ ê° ì§€ìŠ¤ê°• ì‚¼ê°ì£¼ì— ìœ„ì¹˜í•˜ì—¬, í•´ìˆ˜ë©´ ìƒìŠ¹ê³¼ ê°•ë ¥í•´ì§„ ì‚¬ì´í´ë¡ ìœ¼ë¡œ ì¸í•´ ë§¤ë…„ ëŒ€ê·œëª¨ í™ìˆ˜ì™€ ì¹¨ìˆ˜ í”¼í•´ë¥¼ ê²ªê³  ìˆìŠµë‹ˆë‹¤. ìˆ˜ë°±ë§Œ ëª…ì˜ 'ê¸°í›„ ë‚œë¯¼'ì´ ë°œìƒí•˜ì—¬ ë„ì‹œ ë¹ˆë¯¼ ë¬¸ì œë¡œ ì´ì–´ì§€ê³  ìˆìŠµë‹ˆë‹¤.", "ëŒ€ì²˜": "í™ìˆ˜ ì˜ˆì¸¡ ë° ê²½ë³´ ì‹œìŠ¤í…œ ê³ ë„í™”, ìˆ˜ì²œ kmì— ë‹¬í•˜ëŠ” ì œë°© ê±´ì„¤ ë° ë³´ê°•, ì—¼ë¶„ì— ê°•í•œ ë†ì‘ë¬¼ í’ˆì¢… ê°œë°œ ë“±ìœ¼ë¡œ ì ì‘ ë…¸ë ¥ì„ ê¸°ìš¸ì´ê³  ìˆìŠµë‹ˆë‹¤."},
    "ë„¤ëœë€ë“œ": {"í”¼í•´": "êµ­í† ì˜ ì•½ 26%ê°€ í•´ìˆ˜ë©´ë³´ë‹¤ ë‚®ì€ 'í¬ë”(polder)' ì§€í˜•ìœ¼ë¡œ, ì—­ì‚¬ì ìœ¼ë¡œ ë¬¼ê³¼ì˜ ì‹¸ì›€ì„ ê³„ì†í•´ì™”ìŠµë‹ˆë‹¤. ê¸°í›„ ë³€í™”ë¡œ ì¸í•´ í­í’ í•´ì¼ì˜ ìœ„í˜‘ì´ ë”ìš± ì»¤ì§€ê³  ìˆìŠµë‹ˆë‹¤.", "ëŒ€ì²˜": "ì„¸ê³„ ìµœê³  ìˆ˜ì¤€ì˜ ì¹˜ìˆ˜ ì‹œìŠ¤í…œ 'ë¸íƒ€ í”„ë¡œì íŠ¸'ì™€ 'ë£¸ í¬ ë” ë¦¬ë²„(Room for the River)'ë¥¼ í†µí•´ ë°©ì¡°ì œ, ëŒ, ìˆ˜ë¬¸ì„ í†µí•© ê´€ë¦¬í•˜ë©° ìì—°ê³¼ ê³µì¡´í•˜ëŠ” ë°©ì‹ì„ ì±„íƒí•˜ê³  ìˆìŠµë‹ˆë‹¤."},
    "ëŒ€í•œë¯¼êµ­": {"í”¼í•´": "ì„œí•´ì•ˆê³¼ ë‚¨í•´ì•ˆì˜ í•´ìˆ˜ë©´ ìƒìŠ¹ë¥ ì´ ì„¸ê³„ í‰ê· ë³´ë‹¤ ë†’ê²Œ ë‚˜íƒ€ë‚˜ê³  ìˆìŠµë‹ˆë‹¤. ì¸ì²œ, ë¶€ì‚° ë“± ì£¼ìš” í•­êµ¬ ë„ì‹œì™€ í•´ì•ˆ ì €ì§€ëŒ€ì˜ ì¹¨ìˆ˜ ìœ„í—˜ì´ ì¦ê°€í•˜ê³  ìˆìœ¼ë©°, ë°±ì‚¬ì¥ ìœ ì‹¤ê³¼ ê°¯ë²Œ ìƒíƒœê³„ íŒŒê´´ê°€ ìš°ë ¤ë©ë‹ˆë‹¤.", "ëŒ€ì²˜": "ì—°ì•ˆê´€ë¦¬ ê¸°ë³¸ê³„íš ìˆ˜ë¦½, ë°©ì¬ ì‹œì„¤(ë°©íŒŒì œ, ë°°ìˆ˜íŒí”„ì¥) í™•ì¶©, ì—°ì•ˆ ì¹¨ì‹ ëª¨ë‹ˆí„°ë§ ê°•í™”, ì¹œí™˜ê²½ í•´ì•ˆ ë³µì› ì‚¬ì—… ë“±ì„ ì¶”ì§„í•˜ê³  ìˆìŠµë‹ˆë‹¤."}
}

if selected_region != "ì „ ì„¸ê³„":
    st.header(f"ğŸ“ {selected_region} ìƒì„¸ ì •ë³´")
    with st.container(border=True):
        col1, col2 = st.columns(2)
        with col1:
            st.error("í”¼í•´ ì‚¬ë¡€")
            st.write(case_study[selected_region]['í”¼í•´'])
        with col2:
            st.success("ëŒ€ì²˜ ë°©ì•ˆ")
            st.write(case_study[selected_region]['ëŒ€ì²˜'])
    st.markdown("---")


# ----------------------------
# 4. ì§€ë„ ì‹œê°í™” (ìœ„í—˜ ì§€ì—­ ì‹œë®¬ë ˆì´ì…˜)
# ----------------------------
st.header(f"ğŸŒ {selected_year}ë…„, ì§€êµ¬ ì˜¨ë‚œí™” ìœ„í—˜ ì§€ì—­")

@st.cache_data
def generate_map_points(year):
    """ì—°ë„ì— ë”°ë¼ ìœ„í—˜ ì§€ì—­ í¬ì¸íŠ¸ ìˆ˜ë¥¼ ì¡°ì ˆí•˜ì—¬ ì‹œê°ì  ë³€í™”ë¥¼ ì¤ë‹ˆë‹¤."""
    base_points = 50
    # ì—°ë„ê°€ ë†’ì•„ì§ˆìˆ˜ë¡ í¬ì¸íŠ¸ ìˆ˜ê°€ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ëŠ˜ì–´ë‚˜ë„ë¡ ì„¤ì •
    num_points = int(base_points + ((year - 1880) / (2025 - 1880))**2 * 1500)
    df_map = pd.DataFrame({
        "lat": np.random.normal(20, 30, num_points),
        "lon": np.random.normal(0, 60, num_points),
    })
    return df_map

map_data = generate_map_points(selected_year)
st.map(map_data, zoom=1)
st.caption("ì´ ì§€ë„ëŠ” ì‹¤ì œ ë°ì´í„°ê°€ ì•„ë‹Œ, ì—°ë„ì— ë”°ë¥¸ ì§€êµ¬ ì˜¨ë‚œí™” ì‹¬í™” ê²½í–¥ì„ ë³´ì—¬ì£¼ê¸° ìœ„í•œ ì‹œë®¬ë ˆì´ì…˜ì…ë‹ˆë‹¤. ì ì˜ ë°€ë„ê°€ ìœ„í—˜ë„ë¥¼ ìƒì§•í•©ë‹ˆë‹¤.")
st.markdown("---")

# ----------------------------
# 5. ì„±ì°°ê³¼ í–‰ë™
# ----------------------------
with st.container(border=True):
    st.subheader("ğŸ“ ì„±ì°°: ë‚˜ëŠ” ì–¼ë§ˆë‚˜ ì•Œê³  ìˆì„ê¹Œ?")
    st.checkbox("í•´ìˆ˜ë©´ ìƒìŠ¹ì´ ë‚˜ì™€ ë‚´ ì£¼ë³€ì˜ ì‚¶ì— ì§ì ‘ì ì¸ ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆë‹¤ê³  ìƒê°í•œë‹¤.", key="q1")
    st.checkbox("í•´ìˆ˜ë©´ ìƒìŠ¹ ë¬¸ì œ í•´ê²°ì€ ì •ë¶€ì™€ êµ­ì œ ì‚¬íšŒì˜ ë…¸ë ¥ë§Œìœ¼ë¡œëŠ” ë¶€ì¡±í•˜ë‹¤ê³  ìƒê°í•œë‹¤.", key="q2")
    st.checkbox("ì—ë„ˆì§€ ì ˆì•½, ì“°ë ˆê¸° ì¤„ì´ê¸° ë“± ê¸°í›„ ë³€í™”ë¥¼ ëŠ¦ì¶”ê¸° ìœ„í•œ ê°œì¸ì ì¸ í–‰ë™ì— ì°¸ì—¬í•  ì˜í–¥ì´ ìˆë‹¤.", key="q3")

# ----------------------------
# 6. ì¶œì²˜
# ----------------------------
st.sidebar.markdown("---")
st.sidebar.markdown("#### ğŸ“š ë°ì´í„° ë° ì •ë³´ ì¶œì²˜")
st.sidebar.markdown("""
- **í•´ìˆ˜ë©´ ë°ì´í„°:** NASA, NOAA ë“±ì—ì„œ ì œê³µí•˜ëŠ” ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‹œë®¬ë ˆì´ì…˜ ìƒì„±
- **ì°¸ê³  ìë£Œ:** [IPCC Reports](https://www.ipcc.ch/), [NASA Climate Change](https://climate.nasa.gov/), [NOAA Sea Level Rise](https://coast.noaa.gov/slr/)
""")

